local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
    Name = "RotwareHub - Grow a Garden",
    LoadingTitle = "RotwareHub",
    LoadingSubtitle = "Grow a Garden Edition",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = nil,
        FileName = "GrowAGardenConfig"
    },
    Theme = "Default",
})

local MainTab = Window:CreateTab("Main")
local TeleTab = Window:CreateTab("Teleport")
local MiscTab = Window:CreateTab("Misc")

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:FindFirstChildOfClass("Humanoid")

local GameEvents = ReplicatedStorage:WaitForChild("GameEvents")

local AutoHarvestEnabled = false
local AutoPlantEnabled = false
local AutoBuyEnabled = false
local AutoSellEnabled = false
local AutoWalkEnabled = false
local NoClipEnabled = false

local AutoPlantRandomPoints = false
local SelectedSeed = nil

-- Fix: maintain seed options as a table to compare for updates
local CurrentSeedOptions = {}

local function firePrompt(prompt)
    if prompt and prompt:IsA("ProximityPrompt") and prompt.Enabled then
        fireproximityprompt(prompt)
    end
end

local function getSeedStock()
    local SeedShop = LocalPlayer.PlayerGui:FindFirstChild("Seed_Shop")
    if not SeedShop then return {} end

    local stock = {}
    -- Assuming the seeds are direct children under Seed_Shop or its descendants with Stock_Text
    for _, item in pairs(SeedShop:GetDescendants()) do
        if item.Name == "Stock_Text" and item:IsA("TextLabel") then
            local parent = item.Parent
            if parent and parent.Name then
                local count = tonumber(item.Text:match("%d+")) or 0
                stock[parent.Name] = count
            end
        end
    end
    return stock
end

local function buySeed(seed)
    if seed and GameEvents:FindFirstChild("BuySeedStock") then
        GameEvents.BuySeedStock:FireServer(seed)
    end
end

local function plantAtPosition(pos, seed)
    if GameEvents:FindFirstChild("Plant_RE") then
        GameEvents.Plant_RE:FireServer(pos, seed)
    end
end

local function harvestPlant(plant)
    local prompt = plant:FindFirstChildOfClass("ProximityPrompt")
    if prompt and prompt.Enabled then
        fireproximityprompt(prompt)
    end
end

local function getMyFarm()
    local farms = workspace:FindFirstChild("Farm")
    if not farms then return nil end
    for _, farm in pairs(farms:GetChildren()) do
        local important = farm:FindFirstChild("Important")
        if important and important:FindFirstChild("Data") and important.Data:FindFirstChild("Owner") then
            if important.Data.Owner.Value == LocalPlayer.Name then
                return farm
            end
        end
    end
    return nil
end

local function getPlantLocations()
    local myFarm = getMyFarm()
    if not myFarm then return {} end
    local important = myFarm:FindFirstChild("Important")
    if not important then return {} end
    return important:FindFirstChild("Plant_Locations") or {}
end

local function autoPlantLoop()
    while AutoPlantEnabled do
        if not SelectedSeed or SelectedSeed == "" then
            task.wait(1)
        else
            local ownedSeeds = {}
            for _, tool in pairs(LocalPlayer.Backpack:GetChildren()) do
                if tool:IsA("Tool") and tool.Name == SelectedSeed then
                    table.insert(ownedSeeds, tool)
                end
            end
            for _, tool in pairs(Character:GetChildren()) do
                if tool:IsA("Tool") and tool.Name == SelectedSeed then
                    table.insert(ownedSeeds, tool)
                end
            end

            if #ownedSeeds == 0 then
                task.wait(3)
            else
                local plantLocations = getPlantLocations()
                local spots = plantLocations:GetChildren()
                if #spots == 0 then
                    task.wait(3)
                else
                    if AutoPlantRandomPoints then
                        local randomLoc = spots[math.random(1, #spots)]
                        if randomLoc and randomLoc:IsA("BasePart") then
                            plantAtPosition(randomLoc.Position + Vector3.new(0,3,0), SelectedSeed)
                        end
                    else
                        for _, pos in pairs(spots) do
                            if not AutoPlantEnabled then break end
                            if pos:IsA("BasePart") then
                                plantAtPosition(pos.Position + Vector3.new(0,3,0), SelectedSeed)
                                task.wait(0.3)
                            end
                        end
                    end
                    task.wait(1)
                end
            end
        end
    end
end

local function autoHarvestLoop()
    while AutoHarvestEnabled do
        local myFarm = getMyFarm()
        if not myFarm then task.wait(1) else
            local important = myFarm:FindFirstChild("Important")
            if not important then task.wait(1) else
                local plantsPhysical = important:FindFirstChild("Plants_Physical")
                if not plantsPhysical then task.wait(1) else
                    for _, plant in pairs(plantsPhysical:GetChildren()) do
                        if not AutoHarvestEnabled then break end
                        harvestPlant(plant)
                        task.wait(0.3)
                    end
                end
            end
        end
        task.wait(1)
    end
end

local function autoBuyLoop()
    while AutoBuyEnabled do
        if SelectedSeed and SelectedSeed ~= "" then
            buySeed(SelectedSeed)
        end
        task.wait(5)
    end
end

local function autoSellLoop()
    while AutoSellEnabled do
        local sellPad = workspace:FindFirstChild("SellPad") or workspace:FindFirstChild("SellArea")
        if sellPad and Character then
            Character:PivotTo(sellPad.CFrame + Vector3.new(0, 3, 0))
            -- Fix: Try to find and fire the ProximityPrompt on SellPad to trigger selling
            local prompt = nil
            for _, child in pairs(sellPad:GetChildren()) do
                if child:IsA("ProximityPrompt") and child.Enabled then
                    prompt = child
                    break
                end
            end
            if prompt then
                fireproximityprompt(prompt)
            end
        end
        task.wait(3)
    end
end

local function autoWalkLoop()
    while AutoWalkEnabled do
        local myFarm = getMyFarm()
        if not myFarm then task.wait(1) else
            local important = myFarm:FindFirstChild("Important")
            if not important then task.wait(1) else
                local plantsPhysical = important:FindFirstChild("Plants_Physical")
                if not plantsPhysical then task.wait(1) else
                    for _, plant in pairs(plantsPhysical:GetChildren()) do
                        if not AutoWalkEnabled then break end
                        if plant:IsA("Model") then
                            local pos = plant:GetPivot().Position
                            Humanoid:MoveTo(pos)
                            task.wait(2)
                        end
                    end
                end
            end
        end
        task.wait(1)
    end
end

local function noclipLoop()
    while NoClipEnabled do
        if Character then
            for _, part in pairs(Character:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end
        end
        task.wait(0.3)
    end
end

-- Create dropdown but without options initially
local seedDropdown = MainTab:CreateDropdown({
    Name = "Select Seed",
    Options = {},
    CurrentOption = nil,
    MultiSelect = false,
    Flag = "SelectedSeed",
    Callback = function(selection)
        SelectedSeed = selection
    end
})

-- Fix: Update dropdown options and refresh only if changed
local function updateSeedDropdown()
    local stock = getSeedStock()
    local seeds = {}
    for seedName, count in pairs(stock) do
        table.insert(seeds, seedName)
    end
    table.sort(seeds)

    -- Check if seeds list changed, update dropdown only if different
    local changed = false
    if #seeds ~= #CurrentSeedOptions then
        changed = true
    else
        for i = 1, #seeds do
            if seeds[i] ~= CurrentSeedOptions[i] then
                changed = true
                break
            end
        end
    end

    if changed then
        CurrentSeedOptions = seeds
        -- Rayfield doesn't provide a direct clear method, but we can UpdateOptions
        seedDropdown:UpdateOptions(seeds)
        -- If current selected seed no longer exists, reset selection
        if SelectedSeed and not table.find(seeds, SelectedSeed) then
            SelectedSeed = nil
            seedDropdown:SetSelected(nil)
        end
    end
end

task.spawn(function()
    while true do
        updateSeedDropdown()
        task.wait(5) -- update more often to catch buys during runtime
    end
end)

MainTab:CreateToggle({
    Name = "Auto Harvest",
    CurrentValue = false,
    Flag = "AutoHarvest",
    Callback = function(state)
        AutoHarvestEnabled = state
        if state then
            task.spawn(autoHarvestLoop)
        end
    end,
})

MainTab:CreateToggle({
    Name = "Auto Plant",
    CurrentValue = false,
    Flag = "AutoPlant",
    Callback = function(state)
        AutoPlantEnabled = state
        if state then
            task.spawn(autoPlantLoop)
        end
    end,
})

MainTab:CreateToggle({
    Name = "Auto Buy Seed",
    CurrentValue = false,
    Flag = "AutoBuySeed",
    Callback = function(state)
        AutoBuyEnabled = state
        if state then
            task.spawn(autoBuyLoop)
        end
    end,
})

MainTab:CreateToggle({
    Name = "Auto Sell",
    CurrentValue = false,
    Flag = "AutoSell",
    Callback = function(state)
        AutoSellEnabled = state
        if state then
            task.spawn(autoSellLoop)
        end
    end,
})

MainTab:CreateToggle({
    Name = "Auto Walk to Plants",
    CurrentValue = false,
    Flag = "AutoWalk",
    Callback = function(state)
        AutoWalkEnabled = state
        if state then
            task.spawn(autoWalkLoop)
        end
    end,
})

MainTab:CreateToggle({
    Name = "Plant at Random Points",
    CurrentValue = false,
    Flag = "PlantRandomPoints",
    Callback = function(state)
        AutoPlantRandomPoints = state
    end,
})

MiscTab:CreateToggle({
    Name = "No Clip",
    CurrentValue = false,
    Flag = "NoClip",
    Callback = function(state)
        NoClipEnabled = state
        if state then
            task.spawn(noclipLoop)
        else
            if Character then
                for _, part in pairs(Character:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = true
                    end
                end
            end
        end
    end,
})

TeleTab:CreateButton({
    Name = "Teleport to Farm Center",
    Callback = function()
        local myFarm = getMyFarm()
        if myFarm then
            local center = myFarm:FindFirstChild("Center") or myFarm:FindFirstChildWhichIsA("BasePart")
            if center then
                Character:PivotTo(center.CFrame + Vector3.new(0, 3, 0))
            else
                warn("No center found on your farm.")
            end
        else
            warn("You don't own a farm.")
        end
    end,
})

TeleTab:CreateButton({
    Name = "Teleport to Sell Pad",
    Callback = function()
        local sellPad = workspace:FindFirstChild("SellPad") or workspace:FindFirstChild("SellArea")
        if sellPad then
            Character:PivotTo(sellPad.CFrame + Vector3.new(0, 3, 0))
        else
            warn("SellPad not found in workspace.")
        end
    end,
})

return Window
